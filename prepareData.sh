sed 1d ukb.txt | cut -f$(head -1 ukb.txt | tr '\t' '\n' | awk '$1~/^41202-0/||$1~/^41204-0/{printf NR+1","} END{print 2}') | awk 'NR==FNR{gsub(/\./,"",$2);split($2,icd,"|");for(x in icd)orpha[icd[x]]=$1;next} {for(idx=2;idx<=NF;idx++)if($idx in orpha)print $1"\t"orpha[$idx]}' ../results/diseases.txt - | sort | uniq | while read patient orpha; do echo ${patient} >> ../data/pats/${orpha}; done

for f in ../data/pats/*; do n=$(cat $f | wc -l); echo $n | awk -vf=$(basename $f) '{printf f"\t"$1"\t"}'; [ "$n" -lt 5 ] && printf "NA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\tNA\n" || sed 1d ukb.txt | cut -f$(head -1 ukb.txt | tr '\t' '\n' | awk '$1=="31-0.0"||$1=="21022-0.0"||$1~/^41202-0/||$1~/^41204-0/{print NR+1}' | tr '\n' ',' && echo 2) | awk -F'\t' -vicd=$(awk -vf=$(basename $f) '$1==f{gsub(/\./,"",$2);print $2}' ../results/diseases.txt) 'BEGIN{split(icd,code,"|");for(c in code)rem[code[c]]=1} NR==FNR{pat[$1]=1;next} ($1 in pat){if($2!=""){sumSex+=$2;nSex++};if($3!=""){sumAge+=$3;nAge++};delete foundCat;for(idx=4;idx<=NF;idx++)if($idx!=""&&!($idx in rem)){idxCat=substr($idx,1,1);if(idxCat=="D"){val=substr($idx,2)+0;if(val>=50)idxCat=(val<80?"Blood":"Immune")};if(idxCat=="B")idxCat="A";if(idxCat=="D")idxCat="C";if(idxCat=="G")idxCat="F";if(idxCat=="P")idxCat="O";if(idxCat=="T")idxCat="S";foundCat[idxCat]=1};for(f in foundCat)sumCat[f]++;nCat++} END{print sumSex/nSex"\t"sumAge/nAge"\t"sumCat["K"]/nCat"\t"sumCat["I"]/nCat"\t"sumCat["M"]/nCat"\t"sumCat["N"]/nCat"\t"sumCat["E"]/nCat"\t"sumCat["F"]/nCat"\t"sumCat["Immune"]/nCat"\t"sumCat["J"]/nCat"\t"sumCat["S"]/nCat"\t"sumCat["H"]/nCat"\t"sumCat["C"]/nCat"\t"sumCat["L"]/nCat"\t"sumCat["A"]/nCat"\t"sumCat["O"]/nCat"\t"sumCat["Blood"]/nCat"\t"sumCat["Q"]/nCat}' $f -; done > ../data/dis.data

sort -k1,1 ../data/dis.data | join -t$'\t' <(sort -k1,1 ../results/diseases.txt) - | awk -F'\t' '{printf "[\x22"$3"\x22,\x22"$1"\x22,\x22"$2"\x22,\x22"$5"\x22,\x22"$4"\x22"; for(idx=6;idx<=NF;idx++)printf ",\x22"$idx"\x22";printf "]\n"}' | tr '\n' ',' | tr '|' ',' | sed 's/,/, /g' | awk '{print "{ \x22""data\x22: [ "$0" ] }"}' > ../results/disdata.txt
